<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>사주 조회</title>
</head>
<body>
<div class="content-layout pd new-search-saju">
    <div class="content-wrap">
        <div class="name-cont">
            <h5 class="cont-title">이름</h5>
            <div class="cont-area">
                <input type="text" class="info-name" id="serch_name">
            </div>
        </div>

        <div class="gender-cont">
            <h5 class="cont-title">성별</h5>
            <div class="cont-area radio-wrap flex-space-btween-row">
                <input class="text-radio" type="radio" name="gender" id="gender_m" value="M" checked>
                <label class="text-radio-label" for="gender_m">남자</label>
                <input class="text-radio" type="radio" name="gender" id="gender_w" value="W">
                <label class="text-radio-label" for="gender_w">여자</label>
            </div>
        </div>

        <div class="bitrhday-cont">
            <h5 class="cont-title">생년월일</h5>
            <div class="cont-area">
                <input class="" type="text" id="birthday" name="birthday" placeholder="2000-01-01">
                <div class="radio-wrap flex-space-btween-row">
                    <input class="text-radio" type="radio" name="smonth" id="smonth_sol" value="sol" checked>
                    <label class="text-radio-label" for="smonth_sol">양력</label>
                    <input class="text-radio" type="radio" name="smonth" id="smonth_lun" value="lun">
                    <label class="text-radio-label" for="smonth_lun">음력</label>
                </div>
            </div>
        </div>

        <div class="birthtime-cont">
            <h5 class="cont-title">태어난 시간</h5>
            <div class="cont-area">
                <input type="text" id="birthTime" placeholder="00:00" />
                <div class="flex-start">
                    <input type="checkbox" id="knowBirthTimeYn" />
                    <label for="knowBirthTimeYn">시간 모름</label>
                </div>
            </div>
        </div>

        <div class="btn-cont">
            <button class="search-btn" onclick="search()">사주 조회하기</button>
            <div class="flex-space-around-row">
                <!-- 로그인, 회원가입 버튼 (익명 사용자만) -->
                <div th:if="${#authentication == null}">
                    <button class="text-btn" onclick="window.location.href='/loginPage'">로그인</button>
                    <button class="text-btn" onclick="window.location.href='/joinPage'">회원가입</button>
                </div>

                <!-- 저장하기, 회원목록 버튼 (ROLE_USER 권한이 있는 사용자만) -->
                <div th:if="${#authentication?.authorities?.contains('ROLE_USER')}">
                    <button class="text-btn" onclick="">저장하기</button>
                    <button class="text-btn" onclick="">회원목록</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">

    /* 페이지/이미지/css 등 모든 리소스 로드 후에 실행, 주로 이미지&외부 리소스 로드 기다릴 때 사용 */
    $(window).on("load", function() { /* 로직 추가 */ });

    /* HTML 요소가 등록 된 후에 실행, 주 사용 이벤트 */
    $(document).ready(function(){
        fnAddVisitCount();

        //시간모름 체크 시 birthTime 블록처리
        const knowBirthTimeEl = document.getElementById("knowBirthTimeYn");
        knowBirthTimeEl.addEventListener("change", function() {
            const birthTime = document.getElementById("birthTime");
            const knowBirthTimeYn = knowBirthTimeEl.checked ? true : false;
            birthTime.disabled = knowBirthTimeYn;
        });

        // birthTime 이벤트 추가
        const birthTime = document.getElementById("birthTime");
        birthTime.addEventListener("input", function (event) {
            const value = setFormatTimeString(event);
            birthTime.value = value;
        });

        //input 이벤트 추가
        $('#birthday').on('input', function() {
            let input = $(this).val();
            let formattedDate = formatDateString(input);
            $(this).val(formattedDate);
        });
    });

    /**
     * 방문자수 증가 로직
     */
    function fnAddVisitCount() {
        $.ajax({
            url: "<c:url value="/visit"/>",
            type: 'POST',
            data: {},
            success: function(response) {
            },
            error: function(xhr, status, error) {
            }
        });
    }

    /* 조회, 결과 페이지 이동 */
    function search() {
        if(!checkDate() ) return;

        fnCallDateInfoAPI(function(data) {
            if(data) {
                formCallServer(data, "/saju/sajuResult");
// 			$("#content").load("/saju/sajuResult", data);
            } else {
                alert('정보를 불러오지 못했습니다.');
            }
        });
    }

    /* 궁합 사이트 이동 */
    function search2() {
        //기본 데이터를 선택했다면 그대로 넘기도록 함
        const dateInput = document.getElementById('birthday').value;
        const smonth = $("input[name='smonth']").val()

        var data = {
            gender		: $('input[name="gender"]:checked').val(),
            birthday	: document.getElementById('birthday').value,
            smonth 		: $("input[name='smonth']").val()
        }

        formCallServer(data, "/saju/sajuChemistry");
// 	$("#content").load("/saju/sajuChemistry", data);
    }

    //yyyy-mm-dd 형태로 수정
    function formatDateString(input) {
        // 숫자만 남기고 나머지는 제거
        input = input.replace(/[^0-9]/g, '');

        // yyyy-mm-dd 형식에 맞게 포맷팅
        let formatted = '';
        if (input.length >= 4) {
            formatted = input.slice(0, 4);
            if (input.length >= 6) {
                formatted += '-' + input.slice(4, 6);
                if (input.length > 6) {
                    formatted += '-' + input.slice(6, 8);
                }
            } else if (input.length > 4) {
                formatted += '-' + input.slice(4);
            }
        } else {
            formatted = input;
        }

        return formatted;
    }

    //API 호출
    function fnCallDateInfoAPI(callback) {

        // 호출 전 birthTime값 확인(241209)
        const birthTimeValue = getBirthTimeValue();
        if(birthTimeValue=="false") return;

        const dateInput = document.getElementById('birthday').value;
        const smonth = $("input[name='smonth']").val();
        const parts = dateInput.split("-");
        const year = parts[0];
        const month = parts[1];
        const day = parts[2];


        var url = 'http://apis.data.go.kr/B090041/openapi/service/LrsrCldInfoService/getLunCalInfo';				//양력일 조회
        if(smonth == 'lun') url = 'http://apis.data.go.kr/B090041/openapi/service/LrsrCldInfoService/getSolCalInfo';//음력일 조회

        var xhr = new XMLHttpRequest();
        var queryParams = '?' + encodeURIComponent('serviceKey') + '='+'Njev63C4hP6FAMTWCtsUYfhOsPQt42h2%2BfzDRfsobDdGO3T%2BGGeIXcjypeDrX3RdMF3YK8KnRuF22H8p44VLIw%3D%3D'; /*Service Key*/
        queryParams += '&' + encodeURIComponent(smonth+'Year') + '=' + encodeURIComponent(year); /**/
        queryParams += '&' + encodeURIComponent(smonth+'Month') + '=' + encodeURIComponent(month); /**/
        queryParams += '&' + encodeURIComponent(smonth+'Day') + '=' + encodeURIComponent(day); /**/
        xhr.open('GET', url + queryParams);
        xhr.onreadystatechange = function () {
            if(this.readyState == 4) {
                if(this.status == 200) {
                    var xmlString = this.responseText;
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(xmlString, "text/xml");

                    // XML 문서에서 필요한 데이터 추출
                    var lunIljin = xmlDoc.getElementsByTagName("lunIljin")[0]?.childNodes[0]?.nodeValue;	//간지
                    var lunYear = xmlDoc.getElementsByTagName("lunYear")[0]?.childNodes[0]?.nodeValue;	//음력 년도
                    var lunMonth = xmlDoc.getElementsByTagName("lunMonth")[0]?.childNodes[0]?.nodeValue;	//음력 월
                    var lunDay = xmlDoc.getElementsByTagName("lunDay")[0]?.childNodes[0]?.nodeValue;		//음력 일
                    var solYear = xmlDoc.getElementsByTagName("solYear")[0]?.childNodes[0]?.nodeValue;	//양력 년도
                    var solMonth = xmlDoc.getElementsByTagName("solMonth")[0]?.childNodes[0]?.nodeValue;	//양력 월
                    var solDay = xmlDoc.getElementsByTagName("solDay")[0]?.childNodes[0]?.nodeValue;		//양력 일

                    var lunWolgeon = xmlDoc.getElementsByTagName("lunWolgeon")[0]?.childNodes[0]?.nodeValue;	//양력 월주
                    var lunSecha = xmlDoc.getElementsByTagName("lunSecha")[0]?.childNodes[0]?.nodeValue;		//양력 년주

                    var param={};
                    param.lunIljin    	= lunIljin;
                    param.lunYear    	= lunYear;
                    param.lunMonth   	= lunMonth;
                    param.lunDay   	= lunDay;
                    param.solYear    	= solYear;
                    param.solMonth   	= solMonth;
                    param.solDay   	= solDay;
                    param.monthSaju   	= lunWolgeon;
                    param.yearSaju   	= lunSecha;
                    param.birthday  	= $("#birthday").val();
                    param.birthTime	= birthTimeValue;
// 				 param.birthTime	= $("#birthTime").val();
                    param.gender   	= $('input[name="gender"]:checked').val();
                    param.smonth   	= $("input[name='smonth']").val();
                    param.serch_name   = $("input[id='serch_name']").val();

                    callback(param);
                } else {
                    console.error('서버 응답 오류:', this.statusText);
                    callback(null); // 실패 시 콜백 함수에 null 전달
                }
            }
        };
        xhr.send('');
    }

    function getBirthTimeValue() {
        let birthTime = "false";

        // checkbox 확인
        if(knowBirthTimeYnCheck()) {
            return birthTime = "";
        }

        if(birthTimeValidation()) {
            return document.getElementById("birthTime").value+":00";
        } else {
            return birthTime;
        }
    }

    function knowBirthTimeYnCheck() {
        return document.getElementById("knowBirthTimeYn").checked;
    }

    function birthTimeValidation() {
        const birthTime = document.getElementById("birthTime").value;

        // 정규식 패턴: HH:mm 형식 (00:00 ~ 59:59)
        const regex = /^([01][0-9]|2[0-3]):([0-5]?[0-9])$/;

        // 정규식 검사
        const result = regex.test(birthTime);

        if(!result) alert("태어난 시간 값이 00:00~23:59의 형태가 맞는지 확인해주세요.");

        return result;
    }

    function setFormatTimeString(event) {
        let value = event.target.value.replace(/\D/g, ''); // 숫자 외의 모든 문자 제거

        // 입력값 길이에 맞게 HH:mm 포맷으로 변환
        if (value.length > 4) {
            value = value.slice(0, 4); // 최대 4자리까지 입력
        }

        // HH:mm 형식으로 포맷
        if (value.length <= 2) {
            // 시간 부분 (최대 2자리)
            value = value.replace(/(\d{2})/, '$1');
        } else if (value.length <= 4) {
            // 분 부분 (최대 2자리)
            value = value.replace(/(\d{2})(\d{2})/, '$1:$2');
        }
        return value;
    }
</script>

</body>
</html>
